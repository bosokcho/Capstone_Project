# Project Checkpoint 5

**NAMES:**  Madeline Abbott, Aidan Teppema, Daisy Cho

\
\
\
\


```{r include=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(zoo)
library(lubridate)
library(ggmap)
library(reshape2)
library(MASS)
library(viridis)
#library(shiny)
library(rjags)
```

# Progress Made:




# Group Member Roles:

* Madeline--
* Daisy--
* Aidan--


# Research questions:

### 1.

Can we predict the location of future hurricanes based on past locations?

* prior, likelihood, posterior (new location)

### 2.

Can we model the change in frequency of hurricanes based on trends in hurricane windspeed and category, temperature, CO2, and NAO index?

prior: $\lambda_i \sim Pois(\lambda_i)$ ($\lambda_i$ is number of hurricanes in each year $i$)

hyperpriors: $\lambda_i \sim exp(T*t + C*t + N*t)$ (T is temperature, C is CO2 concentration, and N is NAO index)

$T \sim N(0.3, 1)$

$C \sim N(368, 1/100)$

$N \sim N(0.016, 1/0.01)$


### 3. 

Can we predict the intensity of wind speed based on average temperature in that year, average atmospheric C02 levels in that year, and the NAO index for that year?


$c \sim N(368, 1/100)$
$t \sim N(0.3, 1)$
$n \sim N(0.016, 1/0.01)$

# Building simple models

## 1.

Can we predict the location of future hurricanes based on past locations?


* Poisson distribution, predict based off of past latitude and longitude coordinates


Loading the data
```{r}
# Hurricane Frequency
hurricane_data <- read_csv("Historical_Tropical_Storm_Tracks.csv")

hurricane_data<-na.omit(hurricane_data)
hurricane_data<-subset(hurricane_data, select=-c(BTID, AD_TIME))

# select only hurricanes in 1950 and after
recent_hurricanes <- hurricane_data[hurricane_data$YEAR >= 1950, ] 

# table of hurricanes per year
hurricanes_per_year <- recent_hurricanes %>%
  group_by(YEAR) %>%
  summarise(TOTAL_H = n_distinct(NAME))


# Temperature Data
temp_data <- read.csv("ZonAnn.csv")
temp_data[!complete.cases(temp_data),]
temp_data<-na.omit(temp_data)
temp_data<-temp_data[,-(5:15),drop=FALSE]
temp_recent <- temp_data %>%
  filter(Year > 1949)

# select only northern hemisphere temp data
tempN <- subset(temp_recent, select = c(Year, NHem))

# rename the columns
colnames(tempN) <- c("YEAR", "temp")

# join temperature to hurricanes per year table
hurricanes_per_year2 <- merge(x = hurricanes_per_year, y = tempN, by = "YEAR", all.x = TRUE)

# CO2 Data
CO2 <- read_csv("CO2.csv")

# Alter CO2 to remove unnecessary variable trend
CO2 <- subset(CO2, select = -trend)

# get average by year
CO2_yr <- CO2 %>%
  group_by(year) %>%
  summarise(avg_CO2 = mean(average))

# rename columns
colnames(CO2_yr) <- c("YEAR", "avg_CO2")

# join with hurricane per year table
hurricanes_per_year3 <- merge(x = hurricanes_per_year2, y = CO2_yr, by = "YEAR", all.x = TRUE)
# FIX THIS (bc only 1980 onward available)

# NAO Index Data
NAO_index1 <- read_csv("NAO_index_monthly.csv", 
    col_types = cols(Apr = col_number(), 
        Aug = col_number(), Dec = col_number(), 
        Feb = col_number(), Jan = col_number(), 
        Jul = col_number(), Jun = col_number(), 
        Mar = col_number(), May = col_number(), 
        Nov = col_number(), Oct = col_number(), 
        Sep = col_number()))

NAO_index2 <- NAO_index1[, -c(14)]

NAO_index3 <- NAO_index2 %>%
  rename(year = X1) %>%
  mutate(Jul = replace(Jul, Jul < -50| Jul > 50, "")) %>%
  mutate(Aug = replace(Aug, Aug < -50| Aug > 50, "")) %>%
  mutate(Sep = replace(Sep, Sep < -50| Sep > 50, "")) %>%
  mutate(Oct = replace(Oct, Oct < -50| Oct > 50, "")) %>%
  mutate(Nov = replace(Nov, Nov < -50| Nov > 50, "")) %>%
  mutate(Dec = replace(Dec, Dec < -50| Dec > 50, ""))
  
NAO_index <- NAO_index3[-nrow(NAO_index3),] 

# remove 2017 (data for year is incomplete)
NAO_index <- head(NAO_index, -1) 

# reshape table
NAO_index <- melt(NAO_index, id=c("year"))
colnames(NAO_index)[2] <- "month"
colnames(NAO_index)[3] <- "index"

NAO_index$year <- as.factor(NAO_index$year)
NAO_index$index <- as.numeric(NAO_index$index)

# group by year
NAO_yr <- NAO_index %>%
  group_by(year) %>%
  summarise(avg_NAO = mean(index))

# rename columns
colnames(NAO_yr) <- c("YEAR", "avg_NAO")

# join with hurricane data
hurricanes_per_year4 <- merge(x = hurricanes_per_year3, y = NAO_yr, by = "YEAR", all.x = TRUE)

# Remove all rows with missing data
hurricanes_per_year_clean<-na.omit(hurricanes_per_year4)

```


Plot distribution of hurricanes per year
```{r}
ggplot(hurricanes_per_year, aes(x = YEAR, y = TOTAL_H)) + geom_point(color = "orange")
```

Plot hurricanes per year by temperature
```{r}
ggplot(hurricanes_per_year_clean, aes(x = temp, y = TOTAL_H)) + geom_point(color = "skyblue")
```

Hurricanes per year by CO2 levels
```{r}
ggplot(hurricanes_per_year_clean, aes(x = avg_CO2, y = TOTAL_H)) + geom_point(color = "darkslateblue")
```

Hurricanes per year by CO2 levels
```{r}
ggplot(hurricanes_per_year_clean, aes(x = avg_NAO, y = TOTAL_H)) + geom_point(color = "darkseagreen")
```

```{r}
# start r jags here!
location <- data.frame(hurricane_data$LONG, hurricane_data$LAT)

# specify the model
hurricane_model1 <- "model{

  # Data
  for (i in 1:length(location)) {
    location[i] ~ dnorm(mu, tau) #dnorm in rjags takes the PRECISION, not std
  }


  #Priors
  mu ~ dnorm(24, 1/100)  #uses PRECISION
  tau ~ dgamma(3, 5)
}"


# set up an algorithm to simulate the posterior by combining the model (grade_model) and data (x)
# set the random number seed
hurricane_jags1 <- jags.model(textConnection(hurricane_model1), data=list(x=c(lat, long)), inits=list(.RNG.name="base::Wichmann-Hill", .RNG.seed=1989))

# simulate a sample from the posterior
# note that we specify both mu and tau variables
grades_sim <- coda.samples(grades_jags, variable.names = c("mu", "tau"), n.iter=10000)

# store the samples in a data frame:
grades_sample <- data.frame(step = 1:10000, grades_sim[[1]])
head(grades_sample)
```



## 2.

Can we model the change in frequency of hurricanes based on trends in hurricane windspeed and category, temperature, CO2, and NAO index?

```{r}
# get frequency data
hurricanes_recent <- hurricane_data %>%
  filter(YEAR > 1949)

hurricanes_per_year <- group_by(hurricanes_recent, YEAR) %>%
  summarize(length(unique(NAME)))
colnames(hurricanes_per_year)[2] <- "TOTAL_HURRICANES"
ggplot(hurricanes_per_year, aes(x = YEAR, y = TOTAL_HURRICANES)) + geom_point()
View(hurricanes_per_year)

temp_per_year <- 

# specify the model
# Data
y <- hurricanes_per_year["TOTAL_HURRICANES"]


hurricane_model2 <- "model{
  # Data
  for (i in 1:length(y)) {
    y[i] ~ dnorm(beta0 + beta1*x[i] + beta2*z[i], (tau0 + tau1*z[i])) #PRECISION
    }

  #Priors
  beta0 ~ dnorm(0, 1/100) #PRECISION
  beta1 ~ dnorm(0, 1/100) #PRECISION
  beta2 ~ dnorm(0, 1/100) #PRECISION
  tau0 ~ dgamma(1, 10)
  tau1 ~ dgamma(1, 10)
}"


# set up an algorithm to simulate the posterior by combining the model (bball_model) and data (y)
# set the random number seed
bball_jags <- jags.model(textConnection(bball_model), data=list(x=hurricanes_per_year$avg_temp, y=newbox$final_diff, z=newbox$time_elapsed), inits=list(.RNG.name="base::Wichmann-Hill", .RNG.seed=1989))

# simulate a sample from the posterior
# note that we specify both mu and tau variables
bball_sim <- coda.samples(bball_jags, variable.names = c("beta0", "beta1", "beta2", "tau0", "tau1"), n.iter=10000)

# store the samples in a data frame:
bball_sample <- data.frame(step = 1:10000, bball_sim[[1]])
head(bball_sample)
```


## 3.

Can we predict the severity of these disasters based on trends in hurricane windspeed and category, temperature, C02, and NAO index?

```{r}
HURRICANES <- hurricanes_per_year_clean
names(HURRICANES)
```
```{r}
#windspeed <- subset(hurricane_data, select=c("YEAR","WIND_KTS"))

windspeed_yr <- hurricane_data %>%
  group_by(YEAR) %>%
  summarise(avg_windspeed = mean(WIND_KTS))

windspeed_yr

```
# join with hurricane per year table
HURRICANES <- merge(x = hurricanes_per_year_clean, y = windspeed_yr, by = "YEAR", all.x = TRUE)
```


```{r}
library(rjags)

#specify the model
windSpeed_model <- "model{
    #Data
    for(i in 1:length(y)) {
        y[i] ~ dnorm(beta0 + beta1*c + beta2*t + beta3*n, (0.0658^2)^(-1))
        theta[i] ~ dnorm(mu, tau)

    }
    #Priors
    beta1 ~ dnorm(0, 1/100) #PRECISION
    beta2 ~ dnorm(0, 1/100) #PRECISION
    beta3 ~ dnorm(0, 1/100) #PRECISION

}"

#set up an algorithm to simulate the posterior by 
#combining the model (games_model) and data (x)
#set the random number seed
windSpeed_jags <- jags.model(textConnection(windSpeed_model), data=list(y=hurricane_data$WIND_KTS, beta1=HURRICANES$av_CO2, beta2=HURRICANES$temp,beta3=HURRICANES$avg_NAO),
                    inits=list(.RNG.name="base::Wichmann-Hill", .RNG.seed=1989))

#simulate a sample from the posterior 
#note that we specify both mu and tau variables
windSpeed_sim <- coda.samples(windSpeed_jags, variable.names=c("beta0","beta1","beta2"), n.iter=10000)


#store the samples in a data frame:    
windSpeed_sample <- data.frame(step=1:10000, BB_sim[[1]])
head(windSpeed_sample)
```

### Part b
```{r}
fig.height=10
summary(windSpeed_sim)
#traceplot(windSpeed_sim)
#densplot(windSpeed_sim)
```



# OLD STUFF BELOW

# Data

# Hurricanes
```{r}
hurricane_data <- read_csv("Historical_Tropical_Storm_Tracks.csv")

hurricane_data<-na.omit(hurricane_data)
hurricane_data<-subset(hurricane_data, select=-c(BTID, AD_TIME))

#transform(hurricane_data, char = as.numeric(LAT))
#transform(hurricane_data, char = as.numeric(LONG))

hurricane_data$LAT <- as.numeric(hurricane_data$LAT)
hurricane_data$LONG <- as.numeric(hurricane_data$LONG)

dim(hurricane_data)
names(hurricane_data)
head(hurricane_data)
summary(hurricane_data)
```

### Exploratory analysis
```{r}
# select only the hurricanes after 1950 (this is when the naming system started)
hurricanes_recent <- hurricane_data %>%
  filter(YEAR > 1949)
```

Some plots...
```{r}
# Plotting hurricane denisty by location

get_density <- function(x, y, n = 100) {
  dens <- MASS::kde2d(x = x, y = y, n = n)
  ix <- findInterval(x, dens$x)
  iy <- findInterval(y, dens$y)
  ii <- cbind(ix, iy)
  return(dens$z[ii])
}

hurricanes_recent$density <- get_density(hurricanes_recent$LONG, hurricanes_recent$LAT)
# creating a sample data.frame with your lat/lon points
hurricanes_recent$LAT <- as.numeric(hurricanes_recent$LAT)
hurricanes_recent$LONG <- as.numeric(hurricanes_recent$LONG)
#transform(hurricanes_recent, char = as.numeric(LAT))
#transform(hurricanes_recent, char = as.numeric(LONG))

# getting the map
map_hurricanes <- get_map(location = c(lon = mean(hurricanes_recent$LONG), lat = mean(hurricanes_recent$LAT)), zoom = 2, maptype = "terrain", scale = 2)

# plotting the map with some points on it
ggmap(map_hurricanes) +
  geom_point(data = hurricanes_recent, aes(x = LONG, y = LAT, alpha = 0.1, color = density)) + scale_color_viridis() + guides(size=FALSE)
```

```{r}
# Total number of hurricanes per year
hurricanes_per_year <- group_by(hurricanes_recent, YEAR) %>%
  summarize(length(unique(NAME)))
colnames(hurricanes_per_year)[2] <- "TOTAL_HURRICANES"
ggplot(hurricanes_per_year, aes(x = YEAR, y = TOTAL_HURRICANES)) + geom_point()
```

```{r}
# Total number of hurricanes of each category per year
hurricanes_categories <- group_by(hurricanes_recent, YEAR) %>%
  count(CAT)
colnames(hurricanes_categories)[3] <- "TOTAL_HURRICANES"
ggplot(hurricanes_categories, aes(x = YEAR, y = TOTAL_HURRICANES, color = CAT, fill = CAT)) + geom_bar(stat = "identity")
```

```{r fig.height = 2, fig.width = 8}
ggplot(hurricanes_categories, aes(x = YEAR, y = TOTAL_HURRICANES, color = CAT, fill = CAT)) + geom_bar(stat = "identity", position = position_dodge(width = 0.9))
```

```{r}
# Average pressure by year
hurricane_pressure <- group_by(hurricanes_recent, YEAR) %>%
  summarize(mean(PRESSURE))
colnames(hurricane_pressure)[2] <- 'AVG_PRESSURE'
colnames(hurricane_pressure)[1] <- "YEAR"
ggplot(hurricane_pressure, aes(x = YEAR, y = AVG_PRESSURE)) + geom_point() + ylab("Average pressure")
```


```{r}
# Average max wind speed by year
hurricanes_wind <- group_by(hurricanes_recent, YEAR) %>%
  summarize(mean(WIND_KTS))
colnames(hurricanes_wind)[2] <- "AVG_WIND"
ggplot(hurricanes_wind, aes(x = YEAR, y = AVG_WIND)) + geom_point() + ylab("Average wind speed (kts)")

# If you want to save a plot...
#ggsave("hurri_categories2.pdf", plot = last_plot(), height = 5, width = 10)
```


#Temperature
```{r Temperature}
temp_data <- read.csv("ZonAnn.csv")

temp_data[!complete.cases(temp_data),]
temp_data<-na.omit(temp_data)
temp_data<-temp_data[,-(5:15),drop=FALSE]
temp_recent <- temp_data %>%
  filter(Year > 1949)
dim(temp_recent)
names(temp_recent)
head(temp_recent)
summary(temp_recent)

# plot of Global, Northern Hemisphere, Southern Hemisphere deviation from corresponding mean by year
ggplot(temp_recent,aes(x=Year))+
  geom_line(aes(y=Glob, color="Global"))+
  geom_line(aes(y=NHem, color="Northern Hemisphere"))+
  geom_line(aes(y=SHem, color="Southern Hemisphere"))+
  ylab("Temperature Anomolies")+
  geom_smooth(method='lm', aes(Year,Glob), colour="red", size=0.3, se=FALSE)+
  geom_smooth(method='lm', aes(Year,NHem),colour="green", size=0.3, se=FALSE)+
  geom_smooth(method='lm', aes(Year,SHem), colour="blue", size=0.3, se=FALSE)
```


#CO2


# Show increasing CO2 over the years by month
CO2 <- read_csv("CO2.csv")

# Alter CO2 to remove unnecessary variable trend
CO2 <- subset(CO2, select = -trend)

# Alter CO2 to remove unnecessary variable trend
#CO2 <- subset(CO2, select = -trend)

ggplot(CO2, aes(x = month, y = average, color = year)) + geom_point()

# Alter CO2 to remove unnecessary variable trend
CO2 <- subset(CO2, select = -trend)

# Create subset of CO2 data from year 2000 to show only fluxuations in CO2 levels throughout one year

# Show increasing CO2 over the years by month
ggplot(CO2, aes(x = month, y = average, color = year)) + geom_point()


# Create subset of CO2 data from year 2000 to show only fluxuations in CO2 levels throughout one year

CO2_2000 <- subset(CO2, year == 2000)
head(CO2_2000)

# Plot this example
plot(CO2_2000$average ~ CO2_2000$month)

# Create time series to show variation over months and years
Average <- ts(CO2$average, frequency = 12, start = 1980)

# Plot and add axis labels
v1 <- c(1980,1985,1990,1995,2000,2005,2010,2015)
v2 <- c(1980,1985,1990,1995,2000,2005,2010,2015)
plot(Average)
axis(side = 1, 
     at = v1, 
     labels = v2,
     tck=-.05)

# Create colored time series 
CO2$Date <- as.yearmon(paste(CO2$year, CO2$month), "%Y %m")

# Create colored time series 
CO2$Date <- as.yearmon(paste(CO2$year, CO2$month), "%Y %m")

# Plot time series
ggplot(CO2, aes(Date, Average)) + geom_line( aes(colour = year))

# Add trend line
ggplot(CO2, aes(Date, Average)) + geom_line( aes(colour = year)) + geom_smooth()

# Show increasing CO2 over the years by month
ggplot(CO2, aes(x = month, y = average, color = year)) + geom_point()
```



# NAO Index Data

NAO_index1 <- read_csv("NAO_index_monthly.csv", 
    col_types = cols(Apr = col_number(), 
        Aug = col_number(), Dec = col_number(), 
        Feb = col_number(), Jan = col_number(), 
        Jul = col_number(), Jun = col_number(), 
        Mar = col_number(), May = col_number(), 
        Nov = col_number(), Oct = col_number(), 
        Sep = col_number()))

NAO_index2 <- NAO_index1[, -c(14)]

NAO_index3 <- NAO_index2 %>%
  rename(year = X1) %>%
  mutate(Jul = replace(Jul, Jul < -50| Jul > 50, "")) %>%
  mutate(Aug = replace(Aug, Aug < -50| Aug > 50, "")) %>%
  mutate(Sep = replace(Sep, Sep < -50| Sep > 50, "")) %>%
  mutate(Oct = replace(Oct, Oct < -50| Oct > 50, "")) %>%
  mutate(Nov = replace(Nov, Nov < -50| Nov > 50, "")) %>%
  mutate(Dec = replace(Dec, Dec < -50| Dec > 50, ""))
  

NAO_index <- NAO_index3[-nrow(NAO_index3),] 

dim(NAO_index)
names(NAO_index)
head(NAO_index)
summary(NAO_index)


# remove 2017 (data for year is incomplete)
NAO_index <- head(NAO_index, -1) 

# reshape table
NAO_index <- melt(NAO_index, id=c("year"))
colnames(NAO_index)[2] <- "month"
colnames(NAO_index)[3] <- "index"

NAO_index$year <- as.factor(NAO_index$year)
NAO_index$index <- as.numeric(NAO_index$index)

# group by month
NAO_avgMonth <- aggregate(NAO_index[, 3], list(NAO_index$month), mean)

# plot
ggplot(data = NAO_avgMonth, aes(x = Group.1, y = x)) + geom_point(color = "blue") + xlab("month") + ylab("NAO index, averaged across all years")
```


